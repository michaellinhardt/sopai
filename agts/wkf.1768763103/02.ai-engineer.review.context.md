# AI Engineer Review: CLAUDE.md Sub-Agent Issue

## Analysis Assessment

**Verdict:** AGREE with all identified issues. The analysis correctly identifies the root causes.

### Key Insights I Concur With

1. **Ambiguous Conditional Logic** - The "If path provided" clause lacks clarity on source and mechanism. Sub-agents cannot distinguish between "path in my prompt" vs "path from orchestrator."

2. **No Role Distinction** - Critical flaw. The document treats all agents uniformly. Without explicit role separation, sub-agents inherit orchestrator behaviors.

3. **Remember Section** - The startup instruction is a silent trigger. Every agent reading CLAUDE.md will attempt folder creation.

### Additional Insights

**A. Context Inheritance Problem**
Sub-agents receive CLAUDE.md via system context, not explicit instruction. The document must self-detect whether the reader is orchestrator or sub-agent. Since sub-agents are spawned WITH a path parameter, presence/absence of path can signal role.

**B. Fail-Fast Missing**
Current design fails silently (creates folder). Should fail loudly when sub-agent lacks path. This prevents cascading workflow corruption.

**C. Token Efficiency Concern**
Adding role sections and guardrails increases token count. Must balance clarity with compression. Solution: use conditional structure that collapses for sub-agents.

**D. Implicit vs Explicit Path Detection**
Current: "If path provided" is too vague.
Needed: "If **Workflow folder:** line appears in your prompt with explicit path, you are a sub-agent."

## Proposed Architecture

```
[Role Detection] -> [Role-Specific Behavior]
     |
     +-- Path in prompt? -> SUB-AGENT: use path, no folder creation
     |
     +-- No path? -> ORCHESTRATOR: create folder, spawn sub-agents with path
```

## Fix Strategy

1. **Add role detection logic at top** - Based on path presence in prompt
2. **Bifurcate instructions** - Orchestrator vs Sub-agent sections
3. **Add guardrails as hard constraints** - Not suggestions, requirements
4. **Rewrite Remember section** - Qualify as orchestrator-only
5. **Add error behavior** - Sub-agent without path = STOP

## Token Budget

Current CLAUDE.md: ~450 tokens
Target with fixes: ~500-550 tokens (acceptable overhead for reliability)

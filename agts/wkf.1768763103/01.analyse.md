# Analysis: CLAUDE.md Sub-Agent Folder Creation Issue

## Problem Statement
Sub-agents receive CLAUDE.md and incorrectly create new `./agts/wkf.xxx/` folders instead of using the path provided by the orchestrator.

---

## Potential Reasons

### 1. Ambiguous Conditional Logic (Lines 14-16)
**Current:**
```
**Workflow Folder:**
- If path provided (e.g., `./agts/wkf.xxxxxxxxx/`): use it
- Else: `mkdir -p ./agts && mkdir "./agts/wkf.$(date +%s)/"`
```

**Problem:** Sub-agents interpret "If path provided" as "if path is in my prompt." When orchestrator spawns a sub-agent without explicit path in the task description, sub-agent sees no path â†’ triggers mkdir.

**Why:** The condition doesn't specify WHO provides the path or HOW it should be provided.

**Fix:** Add explicit clause: "Sub-agents NEVER create folders. Orchestrator MUST provide path."

---

### 2. No Role Distinction
**Current:** Document addresses "agent" generically without distinguishing orchestrator vs sub-agent.

**Problem:** Every agent (including sub-agents) reads "Startup: create `./agts` if needed" and acts on it.

**Why:** No explicit hierarchy or role-specific instructions.

**Fix:** Add section defining roles:
- Orchestrator: creates folders, spawns sub-agents WITH path
- Sub-agent: receives path, NEVER creates folders

---

### 3. Buried Critical Instruction (Line 20)
**Current:** `- Provide exact path to all agents` is listed as one of many usage notes.

**Problem:** Not prominent enough. Easy to miss when scanning.

**Why:** Critical requirement buried in bullet list.

**Fix:** Elevate to explicit guardrail with emphasis.

---

### 4. Remember Section Triggers Sub-Agents (Line 70-72)
**Current:** `Startup: create ./agts if needed, init workflow files, then execute request.`

**Problem:** Sub-agents read this as their startup instruction and create folders.

**Why:** No qualifier like "Orchestrator only" or "If you are the root agent."

**Fix:** Qualify with role: "**Orchestrator startup:**"

---

### 5. Missing Explicit Guardrail
**Current:** No statement explicitly forbidding sub-agents from folder creation.

**Problem:** Without explicit prohibition, sub-agents follow the generic flow.

**Why:** Assumes sub-agents will receive path, but doesn't enforce it.

**Fix:** Add guardrail section:
```
## Guardrails
- Sub-agents MUST NOT create workflow folders
- Sub-agents MUST receive workflow path from orchestrator
- If no path received, sub-agent should ERROR, not create
```

---

### 6. No Validation/Error Handling
**Current:** Silent behavior when path is missing.

**Problem:** Instead of failing loudly, sub-agents proceed with folder creation.

**Why:** No instruction to validate path presence.

**Fix:** Add: "If sub-agent receives no workflow path: STOP and report error to orchestrator."

---

## Summary Table

| Issue | Location | Severity | Fix Complexity |
|-------|----------|----------|----------------|
| Ambiguous conditional | L14-16 | HIGH | Low |
| No role distinction | Global | HIGH | Medium |
| Buried instruction | L20 | MEDIUM | Low |
| Remember triggers subs | L70-72 | HIGH | Low |
| Missing guardrail | N/A | HIGH | Low |
| No error handling | N/A | MEDIUM | Low |

---

## Recommended Solution

1. Add explicit **Roles** section at top
2. Rewrite **Workflow Folder** with role-specific instructions
3. Add **Guardrails** section with prohibitions
4. Qualify **Remember** section as orchestrator-only
5. Add error handling instruction for sub-agents
